<!-- quiz_update.html: 퀴즈 수정 페이지 -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>퀴즈 수정</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    {% include 'common/navigation.html' %}
    <div class="container mt-5">
      <h2>퀴즈 수정 및 문제 관리</h2>

      <!-- 퀴즈 제목 수정 -->
      <div class="mb-3">
        <label class="form-label">퀴즈 제목</label>
        <input
          type="text"
          id="quizTitle"
          class="form-control"
          value="{{ quiz.title }}"
        />
        <button id="updateQuiz" class="btn btn-success mt-2">
          퀴즈 제목 수정
        </button>
      </div>

      <!-- 문제 목록 -->
      <div id="questionsContainer" class="mt-4">
        <h4>문제 목록</h4>
        {% for question in quiz.questions %}
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">문제 {{ loop.index }}</h5>
            <textarea
              class="form-control mb-3 question-text"
              data-question-id="{{ question.id }}"
            >
{{ question.text }}</textarea
            >
            <div class="mb-3">
              <label class="form-label">선택지</label>
              {% for option in question.options %}
              <div class="input-group mb-2">
                <input
                  type="text"
                  class="form-control option-text"
                  value="{{ option.text }}"
                  data-option-id="{{ option.id }}"
                />
                <button
                  class="btn {% if option.is_correct %}btn-success{% else %}btn-outline-secondary{% endif %} mark-correct"
                  type="button"
                >
                  {% if option.is_correct %}정답 (선택됨){% else %}정답{% endif
                  %}
                </button>
              </div>
              {% endfor %}
            </div>
            <button
              class="btn btn-secondary addOption"
              data-question-id="{{ question.id }}"
            >
              선택지 추가
            </button>
            <button
              class="btn btn-primary updateQuestion mt-2"
              data-question-id="{{ question.id }}"
            >
              문제 수정
            </button>
            <button
              class="btn btn-danger deleteQuestion mt-2"
              data-question-id="{{ question.id }}"
            >
              문제 삭제
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <script>
      // 퀴즈 제목 수정 API 호출
      document
        .getElementById("updateQuiz")
        .addEventListener("click", async () => {
          const quizTitle = document.getElementById("quizTitle").value;

          if (!quizTitle) {
            alert("퀴즈 제목을 입력하세요.");
            return;
          }

          try {
            const response = await fetch(`/quiz/update/{{ quiz.id }}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ title: quizTitle }),
            });

            if (response.ok) {
              alert("퀴즈 제목이 성공적으로 수정되었습니다.");
            } else {
              const errorData = await response.json();
              alert(`퀴즈 제목 수정 실패: ${errorData.detail}`);
            }
          } catch (error) {
            console.error("퀴즈 제목 수정 요청 중 오류 발생:", error);
            alert("퀴즈 제목 수정 요청 중 오류가 발생했습니다.");
          }
        });

      // 문제 수정 API 호출
      document.querySelectorAll(".updateQuestion").forEach((button) => {
        button.addEventListener("click", async () => {
          const questionId = button.dataset.questionId;
          const questionText = document.querySelector(
            `.question-text[data-question-id="${questionId}"]`
          ).value;

          const options = [];
          document
            .querySelectorAll(
              `.option-text[data-option-id][data-question-id="${questionId}"]`
            )
            .forEach((input) => {
              const isCorrect =
                input.nextElementSibling.classList.contains("btn-success");
              options.push({
                id: input.dataset.optionId,
                text: input.value,
                is_correct: isCorrect,
              });
            });

          if (!questionText) {
            alert("문제 내용을 입력하세요.");
            return;
          }

          if (options.length < 2) {
            alert("선택지는 최소 2개 이상이어야 합니다.");
            return;
          }

          if (!options.some((option) => option.is_correct)) {
            alert("최소 1개의 정답을 지정해야 합니다.");
            return;
          }

          if (!confirm("정말로 이 문제를 수정하시겠습니까?")) {
            return;
          }

          try {
            const response = await fetch(
              `/quiz/update/question/${questionId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  text: questionText,
                  options: options,
                }),
              }
            );

            if (response.ok) {
              alert("문제가 성공적으로 수정되었습니다.");
            } else {
              const errorData = await response.json();
              alert(`문제 수정 실패: ${errorData.detail}`);
            }
          } catch (error) {
            console.error("문제 수정 요청 중 오류 발생:", error);
            alert("문제 수정 요청 중 오류가 발생했습니다.");
          }
        });
      });

      // 문제 삭제 API 호출
      document.querySelectorAll(".deleteQuestion").forEach((button) => {
        button.addEventListener("click", async () => {
          const questionId = button.dataset.questionId;

          if (!confirm("정말로 이 문제를 삭제하시겠습니까?")) {
            return;
          }

          try {
            const response = await fetch(
              `/quiz/delete/question/${questionId}`,
              {
                method: "DELETE",
              }
            );

            if (response.ok) {
              alert("문제가 성공적으로 삭제되었습니다.");
              location.reload(); // 페이지 새로고침
            } else {
              const errorData = await response.json();
              alert(`문제 삭제 실패: ${errorData.detail}`);
            }
          } catch (error) {
            console.error("문제 삭제 요청 중 오류 발생:", error);
            alert("문제 삭제 요청 중 오류가 발생했습니다.");
          }
        });
      });

      // 정답 버튼 토글
      document.addEventListener("click", (event) => {
        if (event.target.classList.contains("mark-correct")) {
          event.target.classList.toggle("btn-success");
          event.target.classList.toggle("btn-outline-secondary");
          event.target.textContent = event.target.classList.contains(
            "btn-success"
          )
            ? "정답 (선택됨)"
            : "정답";
        }
      });

      // 선택지 추가
      document.querySelectorAll(".addOption").forEach((button) => {
        button.addEventListener("click", () => {
          const questionId = button.dataset.questionId;
          const optionsContainer = button.previousElementSibling;
          const optionGroup = document.createElement("div");
          optionGroup.className = "input-group mb-2";

          optionGroup.innerHTML = `
            <input type="text" class="form-control option-text" placeholder="선택지 내용" />
            <button class="btn btn-outline-secondary mark-correct" type="button">정답</button>
          `;

          optionsContainer.appendChild(optionGroup);
        });
      });
    </script>
  </body>
</html>
